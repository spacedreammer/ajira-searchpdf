name: Build and Release JobSearchTool

on:
  push:
    tags:
      - "v*"   # Only run when pushing tags like v1.0
  workflow_dispatch:  # Allow manual run

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: pip install -r requirements.txt pyinstaller
      - name: Build EXE
        run: pyinstaller --onefile --windowed tik.py --name JobSearchTool
      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          files: dist/JobSearchTool.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: pip install -r requirements.txt pyinstaller
      - name: Build Linux Binary
        run: pyinstaller --onefile --windowed tik.py --name JobSearchTool
      - name: Package .deb
        run: |
          # Create the directory structure for the .deb package
          mkdir -p jobsearchtool_1.0/usr/bin
          # Copy the built binary to the correct location
          cp dist/JobSearchTool jobsearchtool_1.0/usr/bin/jobsearchtool
          # Create the DEBIAN directory and control file
          mkdir -p jobsearchtool_1.0/DEBIAN
          cat <<EOF > jobsearchtool_1.0/DEBIAN/control
          Package: jobsearchtool
          Version: 1.0
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: Issa <your-email@example.com>
          Description: Job Offer PDF Search Tool
          EOF
          # Build the .deb package and rename it to the correct format
          dpkg-deb --build jobsearchtool_1.0
          mv jobsearchtool_1.0.deb jobsearchtool_1.0_amd64.deb

      - name: Install AppImage tool
        run: sudo apt-get update && sudo apt-get install -y appimagetool

      - name: Package .AppImage
        run: |
          # Create the AppDir directory structure
          mkdir -p JobSearchTool.AppDir/usr/bin
          # Copy the built binary to the correct location
          cp dist/JobSearchTool JobSearchTool.AppDir/usr/bin/JobSearchTool
          # Create the .desktop file
          cat <<EOF > JobSearchTool.AppDir/JobSearchTool.desktop
          [Desktop Entry]
          Name=Job Search Tool
          Exec=JobSearchTool
          Icon=jobsearchtool
          Type=Application
          Categories=Utility;
          EOF
          # Copy other necessary files
          cp README.md JobSearchTool.AppDir/
          # Build the AppImage
          appimagetool JobSearchTool.AppDir

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            jobsearchtool_1.0_amd64.deb
            JobSearchTool.AppDir-x86_64.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
